<!DOCTYPE html>
<html lang="en">

<head>
    <title>RMSI CSV Generator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width" />

    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@material-ui/core@latest/umd/material-ui.production.min.js"crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">

        /* ----- BEGIN: MUI Setup ----- */
        //Import MUI components
        const {
            colors,
            CssBaseline,
            ThemeProvider,
            Typography,
            Container,
            makeStyles,
            createMuiTheme,
            useTheme,
            Box,
            SvgIcon,
            Link,
            Paper,
            TextField,
            Button,
            Select,
            FormControl,
            FormHelperText,
            InputLabel,
            MenuItem,
            FormControlLabel,
            Checkbox,
            Grid,
            Input,
            MenuProps,
            Chip
        } = MaterialUI;

        // Create a MUI theme instance.
        const theme = createMuiTheme({
            palette: {
                primary: {
                    main: '#556cd6',
                },
                secondary: {
                    main: '#19857b',
                },
                error: {
                    main: colors.red.A400,
                },
                background: {
                    default: '#f5f5f5',
                },
            },
        });

        const useStyles = makeStyles(theme => ({
            htmlBody:{
                background: "#f5f5f5",
            },
            root: {
                margin: theme.spacing(6, 0, 3),
            },
            mainContainer: {
                margin: "20px",
                padding: "20px"
            },
            formControl: {
                margin: theme.spacing(1),
                minWidth: 240,
                maxWidth: 240,
            },
            chips: {
                display: 'flex',
                flexWrap: 'wrap',
            },
            chip: {
                margin: 2,
            },
            chosenCountry: {
                color: theme.palette.primary.main,
                background: "blue",
            },
            normalCountry: {

            },
            formTitle:{
                color: theme.palette.primary.main,
            },
            formControlOutlined: {
                margin: theme.spacing(1),
                minWidth: 240,
                maxWidth: 240,
                border: "1px solid lightGray",
                borderRadius: "4px",
            },
            filesButton:{
                color: "blue",
                maxWidth: "0",
            }
        }));
        /* ----- END: MUI Setup ----- */

        /* ----- BEGIN: CSV Helpers ----- */
        const fields = {
            filename: { name: "Filename", type: "", default_value: ""},
            title: { name: "Title", type: "", default_value: ""},
            territories: { name: "Territories", type: "", default_value: ""},
            description: { name: "Description", type: "", default_value: ""},
            category: { name: "Category", type: "", default_value: ""},
            monitoring_type: { name: "Monitoring Type", type: "", default_value: ""},
            match_rule_id: { name: "Match Rule ID", type: "", default_value: ""},
            reference_disabled: { name: "Reference Disabled", type: "", default_value: ""},
            whitelisted_fb_ids: { name: "Whitelisted FB IDs", type: "", default_value: ""},
            whitelisted_ig_ids: { name: "Whitelisted IG IDs", type: "", default_value: ""},
            tags: { name: "Tags", type: "", default_value: ""},
            action: { name: "Action", type: "", default_value: "CREATE"}
        }

        const processFormField = (_field) => {
            let field = document.getElementById(_field);
            if (field !== null) {
                return field.value
            }

            return fields[_field].default_value;
        }

        const processFiles = () => {
            console.log("Files selected...");
            let values = {};
            let csvContent = "";
            for (const f in fields) {
                values[f] = processFormField(f);
                csvContent += fields[f].name + ",";
            }
            csvContent += "\n";
            console.log("Form values: ", values);
            console.log("CSV headings: ", csvContent);

            var inp = document.getElementById("video_files");

            for (let i = 0; i < inp.files.length; i++) {
                let file = inp.files[i];
                values.filename = file.name;
                values.title = file.name;
                for (const f in values) {
                    csvContent += values[f] + ",";
                }
                csvContent += "\n";
                console.log("File", file.name);
            }
            console.log("CSV content: ", csvContent);
            return csvContent;
        }

        const save = (csvContent) => {
            console.log("Saving...");
            let filename = "csv_file.csv";
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) { // feature detection
                    // Browsers that support HTML5 download attribute
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }

        const exportCSV = () => {
            console.log("Exporting CSV file...");
            let csvContent = processFiles();
            //TODO: Uncomment this line
            //save(csvContent);
        }


        const handleChange = (event) => {
            let event_id=event.target.name;
            document.getElementById(event_id).value = event.target.value;
        };

        /* ----- END: CSV Helpers ----- */

        /* ----- BEGIN: Form Components ----- */

        function Heading(){
            const classes = useStyles();
            return(
                <Typography variant="h4" className={classes.formTitle} gutterBottom>
                    RMSI - CSV Generator
                </Typography>
            )
        }

        function Files() {
            const classes = useStyles();
            return (
                <FormControl variant="outlined" className={classes.formControlOutlined}>
                    <label for="video_files">Files:</label>
                    <input
                    type="file"
                    name="video_files"
                    id="video_files"
                    multiple
                    accept=".vid"
                    className={classes.filesButton} />
                </FormControl>
            )
        }

        function Territories() {

            const COUNTRIES = {
                WW: "World Wide",
                AF: "Afghanistan",
                AL: "Albania",
                DZ: "Algeria",
                AS: "American Samoa",
                AD: "Andorra",
                AO: "Angola",
                AI: "Anguilla",
                AQ: "Antarctica",
                AG: "Antigua and Barbuda",
                AR: "Argentina",
                AM: "Armenia",
                AW: "Aruba",
                AU: "Australia",
                AT: "Austria",
                AZ: "Azerbaijan",
            };

            function getClassName(country) {
                return (
                    territoryName.indexOf(country) === -1
                        ? classes.normalCountry
                        : classes.chosenCountry
                );
            }

            const classes = useStyles();
            const [territoryName, setTerritoryName] = React.useState([]);

            const handleChangeTerritories = (event) => {
                setTerritoryName(event.target.value);
                document.getElementById("territories").value = event.target.value;
            };

            let countries = []
            for (const country in COUNTRIES) {
                countries.push(
                    <MenuItem key={country} value={country}
                        className={getClassName(country)}>
                        {COUNTRIES[country]}
                    </MenuItem>
                );
            }


            return (
                <FormControl variant="outlined" className={classes.formControlOutlined}>
                    <InputLabel id="territories-label">Territories</InputLabel>
                    <Select
                        labelId="territories-label"
                        multiple
                        value={territoryName}
                        onChange={handleChangeTerritories}
                        input={<Input id="select-multiple-chip" />}
                        renderValue={(selected) => (
                            <div className={classes.chips}>
                                {selected.map((value) => (
                                    <Chip key={value} label={value} className={classes.chip} />
                                ))}
                            </div>
                        )}
                        MenuProps={MenuProps}
                    >
                        {countries}
                    </Select>
                    <input type="hidden" id="territories" name="territories"/>
                </FormControl>
            )
        }


        function Category() {
            const classes = useStyles();

            const CATEGORY = {
                EPISODE: "Episode",
                MOVIE: "Movie",
                WEB: "Web",
            }

            let categories = []
            for (const category_key in CATEGORY) {
                categories.push(<MenuItem value={category_key}>{CATEGORY[category_key]}</MenuItem>)
            }

            return (
                <FormControl variant="outlined" className={classes.formControl}>
                    <InputLabel id="category-label">Category</InputLabel>
                    <Select
                        labelId="category-label"
                        id="category"
                        name="category"
                        onChange={handleChange}
                    >
                        {categories}
                    </Select>
                </FormControl>
            )
        }

        function MonitoringType() {
            const MONITORING_TYPE = {
                VIDEO_AND_AUDIO: "Video and audio",
                VIDEO_ONLY: "Video only",
                AUDIO_ONLY: "Audio only",
            }

            const classes = useStyles();

            let monitoring_types = []
            for (const mtype in MONITORING_TYPE) {
                monitoring_types.push(<MenuItem value={mtype}>{MONITORING_TYPE[mtype]}</MenuItem>)
            }

            return (
                <FormControl variant="outlined" className={classes.formControl}>
                    <InputLabel id="monitoring-type-label">Monitoring Type</InputLabel>
                    <Select
                        labelId="monitoring-type-label"
                        id="monitoring_type"
                        name="monitoring_type"
                        onChange={handleChange}
                    >
                        {monitoring_types}
                    </Select>
                </FormControl>
            )
        }

        function ReferenceDisabled() {
            const classes = useStyles();
            const [checked, setChecked] = React.useState(false);

            const handleChecked = (event) => {
                setChecked(event.target.checked);
                document.getElementById("reference_disabled").value = event.target.checked;
            };

            return (
                <FormControl className={classes.formControl}>
                    <FormControlLabel
                        control={
                            <Checkbox
                                color="primary"
                                checked={checked}
                                onChange={handleChecked}
                            />
                        }
                        label="Reference Disabled"
                    />
                    <input type="hidden" id="reference_disabled" name="reference_disabled" value="false"/>
                </FormControl>
            )
        }

        function MatchRuleId() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField id="match_rule_id" name="match_rule_id" label="match_rule_id" variant="outlined" />
                </FormControl>
            )
        }

        function AllowedFBIds() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField id="whitelisted_fb_ids" name="whitelisted_fb_ids" label="whitelisted_fb_ids" variant="outlined" />
                </FormControl>
            )
        }

        function AllowedIGIds() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField id="whitelisted_ig_ids" name="whitelisted_ig_ids" label="whitelisted_ig_ids" variant="outlined" />
                </FormControl>
            )
        }

        function Tags() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField id="tags" name="tags" label="tags" variant="outlined" />
                </FormControl>
            )
        }

        function Description() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField
                        id="description"
                        label="Description"
                        multiline
                        rows={4}
                        defaultValue="Generic description for your files"
                        variant="outlined"
                    />
                </FormControl>
            )
        }
        /* ----- END: Form Components ----- */

        /* ----- BEGIN: React Main App ----- */
        function App() {
            const classes = useStyles();
            return (
                <Container maxWidth="b" className={classes.htmlBody}>
                <Container maxWidth="sm">
                    <Paper elevation={3}>
                        <Grid
                            container
                            direction="column"
                            justify="center"
                            alignItems="center"
                            className={classes.mainContainer}>
                            <Grid item xs>
                                <Heading/>
                            </Grid>
                            <Grid item xs>
                                <Files />
                            </Grid>
                            <Grid item xs>
                                <Territories />
                            </Grid>
                            <Grid item xs>
                                <Category />
                            </Grid>
                            <Grid item xs>
                                <MonitoringType />
                            </Grid>
                            <Grid item xs>
                                <MatchRuleId />
                            </Grid>
                            <Grid item xs>
                                <ReferenceDisabled />
                            </Grid>
                            <Grid item xs>
                                <AllowedFBIds />
                            </Grid>
                            <Grid item xs>
                                <AllowedIGIds />
                            </Grid>
                            <Grid item xs>
                                <Tags />
                            </Grid>
                            <Grid item xs>
                                <Description />
                            </Grid>
                            <Grid item xs>
                                <Button variant="contained" color="primary" onClick={exportCSV}>
                                    Export CSV
                                </Button>
                            </Grid>
                        </Grid>
                    </Paper>
                </Container>
                </Container>
            );
        }

        ReactDOM.render(
            <ThemeProvider theme={theme}>
                <CssBaseline />
                <App />
            </ThemeProvider>,
            document.querySelector('#root'),
        );

        /* ----- END: React Main App ----- */

    </script>
</body>

</html>
