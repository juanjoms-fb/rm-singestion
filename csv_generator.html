<!DOCTYPE html>
<html lang="en">

<head>
    <title>RMSI CSV Generator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width" />

    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@material-ui/core@latest/umd/material-ui.production.min.js"crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">

        /* ----- BEGIN: MUI Setup ----- */
        //Import MUI components
        const {
            Box,
            Button,
            Checkbox,
            Chip,
            colors,
            Container,
            createMuiTheme,
            CssBaseline,
            DraftsIcon,
            FormControl,
            FormControlLabel,
            FormHelperText,
            Grid,
            Icon,
            Input,
            InputLabel,
            Link,
            List,
            ListItem,
            ListItemIcon,
            ListItemText,
            makeStyles,
            MenuItem,
            MenuProps,
            Paper,
            Select,
            SvgIcon,
            TextField,
            ThemeProvider,
            Typography,
            useTheme,
        } = MaterialUI;

        // Create a MUI theme instance.
        const theme = createMuiTheme({
            palette: {
                primary: {
                    main: '#556cd6',
                },
                secondary: {
                    main: '#19857b',
                },
                error: {
                    main: colors.red.A400,
                },
                background: {
                    default: '#f5f5f5',
                },
            },
        });

        // Create styles/classes.
        const useStyles = makeStyles(theme => ({
            htmlBody:{
                background: "#f5f5f5",
            },
            root: {
                margin: theme.spacing(6, 0, 3),
            },
            mainContainer: {
                margin: "20px",
                padding: "20px"
            },
            sideContainer: {
                margin: "20px",
                padding: "10px"
            },
            formControl: {
                margin: theme.spacing(1),
                minWidth: 240,
                maxWidth: 240,
            },
            chips: {
                display: 'flex',
                flexWrap: 'wrap',
            },
            chip: {
                margin: 2,
            },
            chosenCountry: {
                color: theme.palette.primary.main,
                background: "blue",
            },
            normalCountry: {

            },
            formTitle:{
                color: theme.palette.primary.main,
            },
            formControlOutlined: {
                margin: theme.spacing(1),
                minWidth: 240,
                maxWidth: 240,
                border: "1px solid lightGray",
                borderRadius: "4px",
            },
            filesButton:{
                display: "none",
            },
            filesLabel: {
                border: "1px solid #ccc",
                display: "inline-block",
                padding: "6px 12px",
                cursor: "pointer",
            },
            files: {
                border: "none 0px",
            },
            icon: {
                marginRight: theme.spacing.unit,
            },
        }));
        /* ----- END: MUI Setup ----- */

        /* ----- BEGIN: CSV Helpers ----- */
        const fields = {
            filename: { name: "Filename", type: "", default_value: ""},
            title: { name: "Title", type: "", default_value: ""},
            territories: { name: "Territories", type: "", default_value: ""},
            description: { name: "Description", type: "", default_value: ""},
            category: { name: "Category", type: "", default_value: ""},
            monitoring_type: { name: "Monitoring Type", type: "", default_value: ""},
            match_rule_id: { name: "Match Rule ID", type: "", default_value: ""},
            reference_disabled: { name: "Reference Disabled", type: "", default_value: ""},
            whitelisted_fb_ids: { name: "Whitelisted FB IDs", type: "", default_value: ""},
            whitelisted_ig_ids: { name: "Whitelisted IG IDs", type: "", default_value: ""},
            tags: { name: "Tags", type: "", default_value: ""},
            action: { name: "Action", type: "", default_value: "CREATE"}
        }

        const processFormField = (_field) => {
            let field = document.getElementById(_field);
            if (field !== null) {
                return field.value
            }
            return fields[_field].default_value;
        }

        const getVideoTitle = (video) =>{
            const index = video.lastIndexOf(".");
            const title = video.substring(0, index);
            let str = title.toLowerCase().split(' ');
            for (var i = 0; i < str.length; i++) {
                str[i] = str[i].charAt(0).toUpperCase() + str[i].slice(1);
            }
            return str.join(' ');
        }

        const generateCSVContent = () => {
            console.log("Generating CSV content");
            let values = {};
            let csvContent = "";

            for (const f in fields) {
                values[f] = processFormField(f);
                csvContent += fields[f].name + ",";
            }
            csvContent += "\n";
            var videos = document.getElementById("video_files");
            for (let i = 0; i < videos.files.length; i++) {
                let file = videos.files[i];
                values.filename = file.name;
                values.title = getVideoTitle(file.name);
                for (const f in values) {
                    csvContent += "\""+values[f] + "\",";
                }
                csvContent += "\n";
            }
            console.log("CSV content: \n", csvContent);
            return csvContent;
        }

        const exportFile = (csvContent) => {
            console.log("Exporting CSV file");
            let filename = "csv_file.csv";
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) { // feature detection
                    // Browsers that support HTML5 download attribute
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            console.log("CSV file exported as ", filename);
        }

        const generateCSVFile = () => {
            const csvContent = generateCSVContent();
            exportFile(csvContent);
        }

        const handleChange = (event) => {
            let event_id=event.target.name;
            document.getElementById(event_id).value = event.target.value;
        };

        /* ----- END: CSV Helpers ----- */

        /* ----- BEGIN: Form Components ----- */

        function Heading(){
            const classes = useStyles();
            return(
                <Typography variant="h4" className={classes.formTitle} gutterBottom>
                    RMSI - CSV Generator
                </Typography>
            )
        }

        function Files() {
            const classes = useStyles();
            const [filesCount, setFilesCount] = React.useState(0);

            const onChangeFiles = ()=>{
                var videos = document.getElementById("video_files");
                setFilesCount(videos.files.length)

            }

            return (
                <FormControl variant="outlined" className={classes.formControlOutlined}>
                    <label for="video_files" className={classes.filesLabel}>Files *: {filesCount}</label>
                    <input
                    type="file"
                    name="video_files"
                    id="video_files"
                    multiple
                    required
                    accept=".vid"
                    className={classes.filesButton}
                    onChange={onChangeFiles}/>
                </FormControl>
            )
        }

        function Territories() {
            const classes = useStyles();
            const [territoryName, setTerritoryName] = React.useState([]);
            const [countries, setCountries] = React.useState({});

            React.useEffect(() => {
                async function getCountries() {
                    const response = await fetch('https://raw.githubusercontent.com/juanjoms-fb/rm-singestion/main/Territories%20ISO%20Alpha%202.csv')
                    const reader = response.body.getReader()
                    const result = await reader.read() // raw array
                    const decoder = new TextDecoder('utf-8')
                    const csv = decoder.decode(result.value) // the csv text
                    const results = Papa.parse(csv, { header: false }) // object with { data, errors, meta }
                    const rows = results.data // array of objects
                    let c = {}
                    rows.forEach( e=>{
                        c[e[0]] = e[1];
                    })
                    setCountries(c)
                }
                getCountries()
            }, []) // [] means just do this once, after initial render

            const getClassName = (country) => {
                return (
                    territoryName.indexOf(country) === -1
                        ? classes.normalCountry
                        : classes.chosenCountry
                );
            }

            const handleChangeTerritories = (event) => {
                setTerritoryName(event.target.value);
                document.getElementById("territories").value = event.target.value;
            };

            const populateCountryList = () => {
                let countryEntries = []
                for (const country in countries) {
                    countryEntries.push(
                        <MenuItem key={country} value={country}
                            className={getClassName(country)}>
                            {countries[country]}
                        </MenuItem>
                    );
                }
                return countryEntries;
            }

            return (
                <FormControl variant="outlined" className={classes.formControlOutlined}>
                    <InputLabel id="territories-label">Territories *</InputLabel>
                    <Select
                        labelId="territories-label"
                        multiple
                        required
                        value={territoryName}
                        onChange={handleChangeTerritories}
                        input={<Input id="select-multiple-chip" />}
                        renderValue={(selected) => (
                            <div className={classes.chips}>
                                {selected.map((value) => (
                                    <Chip key={value} label={value} className={classes.chip} />
                                ))}
                            </div>
                        )}
                        MenuProps={MenuProps}
                    >
                        {populateCountryList()}
                    </Select>
                    <input type="hidden" id="territories" name="territories"/>
                </FormControl>
            )
        }

        function Category() {
            const classes = useStyles();

            const CATEGORY = {
                EPISODE: "Episode",
                MOVIE: "Movie",
                WEB: "Web",
            }

            let categories = []
            for (const category_key in CATEGORY) {
                categories.push(<MenuItem value={category_key}>{CATEGORY[category_key]}</MenuItem>)
            }

            return (
                <FormControl variant="outlined" className={classes.formControl}>
                    <InputLabel id="category-label">Category *</InputLabel>
                    <Select
                        labelId="category-label"
                        id="category"
                        name="category"
                        required
                        onChange={handleChange}
                    >
                        {categories}
                    </Select>
                </FormControl>
            )
        }

        function MonitoringType() {
            const MONITORING_TYPE = {
                VIDEO_AND_AUDIO: "Video and audio",
                VIDEO_ONLY: "Video only",
                AUDIO_ONLY: "Audio only",
            }

            const classes = useStyles();

            let monitoring_types = []
            for (const mtype in MONITORING_TYPE) {
                monitoring_types.push(<MenuItem value={mtype}>{MONITORING_TYPE[mtype]}</MenuItem>)
            }

            return (
                <FormControl variant="outlined" className={classes.formControl}>
                    <InputLabel id="monitoring-type-label">Monitoring Type *</InputLabel>
                    <Select
                        labelId="monitoring-type-label"
                        id="monitoring_type"
                        name="monitoring_type"
                        required
                        onChange={handleChange}
                    >
                        {monitoring_types}
                    </Select>
                </FormControl>
            )
        }

        function ReferenceDisabled() {
            const classes = useStyles();
            const [checked, setChecked] = React.useState(false);

            const handleChecked = (event) => {
                setChecked(event.target.checked);
                document.getElementById("reference_disabled").value = event.target.checked;
            };

            return (
                <FormControl className={classes.formControl}>
                    <FormControlLabel
                        control={
                            <Checkbox
                                color="primary"
                                checked={checked}
                                onChange={handleChecked}
                            />
                        }
                        label="Reference Disabled"
                    />
                    <input type="hidden" id="reference_disabled" name="reference_disabled" value="false"/>
                </FormControl>
            )
        }

        function MatchRuleId() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField
                    id="match_rule_id"
                    name="match_rule_id"
                    label="Match Rule Id"
                    variant="outlined"
                    required/>
                </FormControl>
            )
        }

        function AllowedFBIds() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField
                    id="whitelisted_fb_ids"
                    name="whitelisted_fb_ids"
                    label="Allowed FB ids"
                    variant="outlined"
                    defaultValue=""
                    helperText="id1,id2,..."
                    />
                </FormControl>
            )
        }

        function AllowedIGIds() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField
                    id="whitelisted_ig_ids"
                    name="whitelisted_ig_ids"
                    label="Allowed IG ids"
                    variant="outlined"
                    defaultValue=""
                    helperText="id1,id2,..."
                    />
                </FormControl>
            )
        }

        function Tags() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField
                    id="tags"
                    name="tags"
                    label="Tags"
                    variant="outlined"
                    defaultValue=""
                    helperText="tag1,tag2"
                    />
                </FormControl>
            )
        }

        function Description() {
            const classes = useStyles();
            return (
                <FormControl className={classes.formControl}>
                    <TextField
                        id="description"
                        label="Description"
                        multiline
                        rows={4}
                        defaultValue="Files uploaded via RMSI"
                        variant="outlined"
                    />
                </FormControl>
            )
        }

        function CSVForm(){
            const classes = useStyles();

            return(
                <Paper elevation={3}>
                        <Grid
                            container
                            direction="column"
                            justify="center"
                            alignItems="center"
                            className={classes.mainContainer}>
                            <Grid item xs>
                                <Heading/>
                            </Grid>
                            <Grid item xs>
                                <Files />
                            </Grid>
                            <Grid item xs>
                                <Territories />
                            </Grid>
                            <Grid item xs>
                                <Category />
                            </Grid>
                            <Grid item xs>
                                <MonitoringType />
                            </Grid>
                            <Grid item xs>
                                <MatchRuleId />
                            </Grid>
                            <Grid item xs>
                                <ReferenceDisabled />
                            </Grid>
                            <Grid item xs>
                                <AllowedFBIds />
                            </Grid>
                            <Grid item xs>
                                <AllowedIGIds />
                            </Grid>
                            <Grid item xs>
                                <Tags />
                            </Grid>
                            <Grid item xs>
                                <Description />
                            </Grid>
                            <Grid item xs>
                                <Button variant="contained" color="primary" onClick={generateCSVFile}>
                                    Export CSV
                                </Button>
                            </Grid>
                        </Grid>
                    </Paper>
            )
        }

        function ListItemLink(props) {
            return <ListItem button component="a" {...props} />;
        }

        function Help(){
            const classes = useStyles();

            return(
                <Paper
                className={classes.sideContainer}
                elevation={3}>
                <Container>
                    <Typography variant="h6" className={classes.formTitle} gutterBottom>
                        Useful links
                    </Typography>
                </Container>
                <List component="nav" aria-label="main mailbox folders">
                    <ListItemLink href="https://developers.facebook.com/docs/rights-manager-video/csv-validator">
                        <ListItemIcon>
                            <Icon className={classes.icon}>done</Icon>
                        </ListItemIcon>
                        <ListItemText primary="CSV Validator" />
                    </ListItemLink>
                    <ListItemLink href="https://github.com/juanjoms-fb/rm-singestion/raw/main/RMSI%20Documentation.pdf">
                        <ListItemIcon>
                            <Icon className={classes.icon}>article</Icon>
                        </ListItemIcon>
                        <ListItemText primary="Documentation" />
                    </ListItemLink>
                    <ListItemLink href="mailto:oncall+rights_manager_scaled_ingestion@xmail.facebook.com">
                        <ListItemIcon>
                            <Icon className={classes.icon}>alternate_email</Icon>
                        </ListItemIcon>
                        <ListItemText primary="Support" />
                    </ListItemLink>
                </List>
                </Paper>
            )
        }
        /* ----- END: Form Components ----- */

        /* ----- BEGIN: React Main App ----- */
        function App() {
            const classes = useStyles();
            return (
                <Container className={classes.htmlBody}>
                <Grid container spacing={1}>
                    <Grid item xs={12} sm={8}>
                        <CSVForm/>
                    </Grid>
                    <Grid item xs={12} sm={4}>
                        <Help/>
                    </Grid>
                </Grid>
                </Container>
            );
        }

        ReactDOM.render(
            <ThemeProvider theme={theme}>
                <CssBaseline />
                <App />
            </ThemeProvider>,
            document.querySelector('#root'),
        );

        /* ----- END: React Main App ----- */

    </script>
</body>

</html>
